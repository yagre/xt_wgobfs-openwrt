name: Create Release on Tag

on:
  push:
    tags:
      - "v*.*.*"
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWRT version (e.g., 24.10.3)'
        required: true
        type: string
      targets:
        description: 'Targets (comma-separated, e.g., "stm32,ramips")'
        required: true
        type: string
      subtargets:
        description: 'Subtargets (comma-separated, e.g., "stm32mp1,mt7621")'
        required: true
        type: string

jobs:
  generate-config:
    runs-on: ubuntu-latest
    outputs:
      job-config: ${{ steps.generate-config.outputs.job-config }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.16.0'

      - name: Get OpenWRT version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -z "${{ inputs.tag_name }}" ]; then
            echo "workflow_dispatch triggered"
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
            echo "TARGETS=${{ inputs.targets }}" >> $GITHUB_ENV
            echo "SUBTARGETS=${{ inputs.subtargets }}" >> $GITHUB_ENV
          elif [ -n "${{ inputs.tag_name }}" ]; then
            echo "workflow_call triggered"
            VERSION="${{ inputs.tag_name }}"
            echo "VERSION=${VERSION#v}" >> $GITHUB_ENV
          else
            echo "VERSION=${GITHUB_REF/refs\/tags\/v/}" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: npm install

      - name: Generate Job Config
        id: generate-config
        run: node index.js ${{ env.VERSION }} "${{ env.TARGETS }}" "${{ env.SUBTARGETS }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: "v${{ matrix.build_env.tag }} - ${{ matrix.build_env.pkgarch}} :: ${{ matrix.build_env.target}}/${{ matrix.build_env.subtarget}} build"
    runs-on: ubuntu-latest
    needs: generate-config
    strategy:
      matrix:
        build_env: ${{ fromJson(needs.generate-config.outputs.job-config) }}
      fail-fast: false

    steps:
      - name: Checkout xt_wgobfs source code
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pyelftools

      - name: Cache OpenWrt SDK
        id: cache-sdk
        uses: actions/cache@v4
        env:
          cache-name: "cache-sdk-${{ matrix.build_env.tag }}-${{ matrix.build_env.target}}-${{ matrix.build_env.subtarget}}"
        with:
          path: openwrt-sdk-*/
          key: ${{ runner.os }}-sdk-${{ env.cache-name }}

      - name: Download and extract OpenWrt SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          echo "pkgarch: ${{ matrix.build_env.pkgarch}}, target:${{ matrix.build_env.target}}, subtarget: ${{ matrix.build_env.subtarget}}"

          # Get the actual SDK filename from the directory listing
          SDK_FILE=$(curl -s "https://downloads.openwrt.org/releases/${{ matrix.build_env.tag }}/targets/${{ matrix.build_env.target}}/${{ matrix.build_env.subtarget}}/" | grep -o "openwrt-sdk-${{ matrix.build_env.tag }}-${{ matrix.build_env.target}}-${{ matrix.build_env.subtarget}}_gcc-[^\"]*_musl[^\"]*\.Linux-x86_64\.tar\.[xz|zst]*" | head -n1)
          
          if [ -z "$SDK_FILE" ]; then
            echo "SDK file not found for ${{ matrix.build_env.tag }} ${{ matrix.build_env.target}} ${{ matrix.build_env.subtarget}}"
            exit 1
          fi
          
          SDK_DOWNLOAD_URL="https://downloads.openwrt.org/releases/${{ matrix.build_env.tag }}/targets/${{ matrix.build_env.target}}/${{ matrix.build_env.subtarget}}/${SDK_FILE}"
          echo "Downloading SDK: $SDK_DOWNLOAD_URL"
          
          wget "$SDK_DOWNLOAD_URL"
          
          # Extract based on file extension
          if [[ "$SDK_FILE" == *.tar.zst ]]; then
            tar --zstd -xf "$SDK_FILE"
          elif [[ "$SDK_FILE" == *.tar.xz ]]; then
            tar -xf "$SDK_FILE"
          else
            echo "Unknown archive format: $SDK_FILE"
            exit 1
          fi
          
          rm "$SDK_FILE"

      - name: Setup SDK and feeds
        run: |
          # Find SDK directory
          SDK_DIR=$(find . -maxdepth 1 -name "openwrt-sdk-*" -type d | head -n1)
          
          if [ -z "$SDK_DIR" ]; then
            echo "SDK directory not found"
            exit 1
          fi
          
          # Get absolute paths
          WORKSPACE_DIR=$(pwd)
          cd "$SDK_DIR"
          
          ./scripts/feeds update -a
          ./scripts/feeds install xtables-addons
          
          # Check if xt_wgobfs needs update and if packages already exist
          if [ -d package/xt_wgobfs/.git ]; then
            # Get current commit hash before update
            OLD_HASH=$(git -C package/xt_wgobfs rev-parse HEAD)
            git -C package/xt_wgobfs fetch --all
            git -C package/xt_wgobfs reset --hard origin/HEAD
            NEW_HASH=$(git -C package/xt_wgobfs rev-parse HEAD)
            
            echo "Old commit: $OLD_HASH"
            echo "New commit: $NEW_HASH"
            
            # Check if repository was updated
            if [ "$OLD_HASH" != "$NEW_HASH" ]; then
              echo "xt_wgobfs repository was updated, packages need rebuild"
              echo "REBUILD_NEEDED=true" >> $GITHUB_ENV
            else
              echo "xt_wgobfs repository is up to date"
              echo "REBUILD_NEEDED=false" >> $GITHUB_ENV
            fi
          else
            echo "xt_wgobfs repository not found, cloning..."
            rm -rf package/xt_wgobfs
            git clone https://github.com/infinet/xt_wgobfs.git package/xt_wgobfs
            echo "REBUILD_NEEDED=true" >> $GITHUB_ENV
          fi
          
          # Check if packages already exist
          if find bin/packages -name "*wgobfs*.ipk" 2>/dev/null | grep -q . || find bin/targets -name "*wgobfs*.ipk" 2>/dev/null | grep -q .; then
            echo "Pre-built packages found"
            echo "PACKAGES_EXIST=true" >> $GITHUB_ENV
          else
            echo "No pre-built packages found"
            echo "PACKAGES_EXIST=false" >> $GITHUB_ENV
          fi
          
          # Only run defconfig if rebuild is needed or packages don't exist
          if [ "$REBUILD_NEEDED" = "true" ] || [ "$PACKAGES_EXIST" = "false" ]; then
            mkdir -p ./package/feeds/packages/xtables-wgobfs
            mv ./package/xt_wgobfs/openwrt/package/Makefile ./package/feeds/packages/xtables-wgobfs/
            make defconfig
          else
            echo "Skipping defconfig - packages exist and no updates needed"
          fi

      - name: Build xt_wgobfs packages
        if: env.REBUILD_NEEDED == 'true' || env.PACKAGES_EXIST == 'false'
        run: |
          SDK_DIR=$(find . -maxdepth 1 -name "openwrt-sdk-*" -type d | head -n1)
          cd "$SDK_DIR"

          echo "Building xt_wgobfs packages..."
          make package/xtables-wgobfs/compile V=s
          
          echo "Build completed. Checking for built packages..."
          find bin/ -name "*.ipk" | grep -E "(wgobfs)" | head -10

      - name: Prepare artifacts
        run: |
          # Find SDK directory
          SDK_DIR=$(find . -maxdepth 1 -name "openwrt-sdk-*" -type d | head -n1)
          
          mkdir -p wgobfsrelease
          postfix="v${{ matrix.build_env.tag }}_${{ matrix.build_env.pkgarch}}_${{ matrix.build_env.target}}_${{ matrix.build_env.subtarget}}"
          
          # Copy built packages
          find "$SDK_DIR/bin/packages" -name "iptables-mod-wgobfs_*.ipk" -exec cp {} "wgobfsrelease/iptables-mod-wgobfs_${postfix}.ipk" \; || echo "iptables-mod-wgobfs package not found"
          find "$SDK_DIR/bin/targets" -name "kmod-ipt-wgobfs_*.ipk" -exec cp {} "wgobfsrelease/kmod-ipt-wgobfs_${postfix}.ipk" \; || echo "kmod-ipt-wgobfs package not found"
          
          echo "Built packages:"
          ls -la wgobfsrelease/

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: wgobfsrelease/*.ipk
          tag_name: v${{ matrix.build_env.tag }}