name: Create Release on Tag

on:
  push:
    tags:
      - "v*.*.*"
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWRT version (e.g., 24.10.3)'
        required: true
        type: string
      targets:
        description: 'Targets (comma-separated, e.g., "stm32,ramips")'
        required: true
        type: string
      subtargets:
        description: 'Subtargets (comma-separated, e.g., "stm32mp1,mt7621")'
        required: true
        type: string

jobs:
  generate-config:
    runs-on: ubuntu-latest
    outputs:
      job-config: ${{ steps.generate-config.outputs.job-config }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.16.0'

      - name: Get OpenWRT version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -z "${{ inputs.tag_name }}" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
            echo "TARGETS=${{ inputs.targets }}" >> $GITHUB_ENV
            echo "SUBTARGETS=${{ inputs.subtargets }}" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" == "workflow_call" ] || [ -n "${{ inputs.tag_name }}" ]; then
            VERSION="${{ inputs.tag_name }}"
            echo "VERSION=${VERSION#v}" >> $GITHUB_ENV
          else
            echo "VERSION=${GITHUB_REF/refs\/tags\/v/}" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: npm install

      - name: Generate Job Config
        id: generate-config
        run: node index.js ${{ env.VERSION }} "${{ env.TARGETS }}" "${{ env.SUBTARGETS }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: "v${{ matrix.build_env.tag }} - ${{ matrix.build_env.pkgarch}} :: ${{ matrix.build_env.target}}/${{ matrix.build_env.subtarget}} build"
    runs-on: ubuntu-latest
    needs: generate-config
    strategy:
      matrix:
        build_env: ${{ fromJson(needs.generate-config.outputs.job-config) }}
      fail-fast: false

    steps:
      - name: Checkout xt_wgobfs source code
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pyelftools

      - name: Cache OpenWrt SDK
        id: cache-sdk
        uses: actions/cache@v4
        env:
          cache-name: "cache-sdk-${{ matrix.build_env.tag }}-${{ matrix.build_env.target}}-${{ matrix.build_env.subtarget}}"
        with:
          path: openwrt-sdk-*/
          key: ${{ runner.os }}-sdk-${{ env.cache-name }}

      - name: Download and extract OpenWrt SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          echo "pkgarch: ${{ matrix.build_env.pkgarch}}, target:${{ matrix.build_env.target}}, subtarget: ${{ matrix.build_env.subtarget}}"

          # Try mirror first, then fallback to main site
          MIRRORS=(
            "https://mirror-03.infra.openwrt.org"
            "https://downloads.openwrt.org"
          )
          
          for MIRROR in "${MIRRORS[@]}"; do
            echo "Trying mirror: $MIRROR"
            
            SDK_FILE=$(curl -s "$MIRROR/releases/${{ matrix.build_env.tag }}/targets/${{ matrix.build_env.target}}/${{ matrix.build_env.subtarget}}/" | grep -o "openwrt-sdk-${{ matrix.build_env.tag }}-${{ matrix.build_env.target}}-${{ matrix.build_env.subtarget}}_gcc-[^\"]*_musl[^\"]*\.Linux-x86_64\.tar\.[xz|zst]*" | head -n1)
            
            if [ -n "$SDK_FILE" ]; then
              SDK_DOWNLOAD_URL="$MIRROR/releases/${{ matrix.build_env.tag }}/targets/${{ matrix.build_env.target}}/${{ matrix.build_env.subtarget}}/${SDK_FILE}"
              echo "Found SDK at: $SDK_DOWNLOAD_URL"
              
              if wget -q "$SDK_DOWNLOAD_URL"; then
                echo "Successfully downloaded from $MIRROR"
                
                # Extract based on file extension
                if [[ "$SDK_FILE" == *.tar.zst ]]; then
                  tar --zstd -xf "$SDK_FILE"
                elif [[ "$SDK_FILE" == *.tar.xz ]]; then
                  tar -xf "$SDK_FILE"
                else
                  echo "Unknown archive format: $SDK_FILE"
                  exit 1
                fi
                
                rm "$SDK_FILE"
                break
              else
                echo "Download failed from $MIRROR, trying next mirror..."
                continue
              fi
            else
              echo "No SDK file found at $MIRROR"
            fi
          done
          
          if [ -z "$SDK_FILE" ] || [ ! -d "openwrt-sdk-"* ]; then
            echo "Failed to download SDK from all mirrors"
            exit 1
          fi

      - name: Setup SDK and feeds
        run: |
          # Find SDK directory
          SDK_DIR=$(find . -maxdepth 1 -name "openwrt-sdk-*" -type d | head -n1)
          
          if [ -z "$SDK_DIR" ]; then
            echo "SDK directory not found"
            exit 1
          fi
          
          cd "$SDK_DIR"
          # Replace src-git-full with src-git to simplify base feeds update
          sed -i 's|src-git-full|src-git|g' feeds.conf.default

          # Function to update feeds with multiple fallbacks
          update_feeds_robust() {
            local attempt=1
            local max_attempts=3
            
            while [ $attempt -le $max_attempts ]; do
              echo "Feeds update attempt $attempt of $max_attempts..."
              
              # Replace URLs in feeds.conf.default based on attempt
              if [ $attempt -eq 1 ]; then
                echo "Trying original feeds source..."
              elif [ $attempt -eq 2 ]; then
                echo "Replacing OpenWRT git URLs with GitHub mirrors..."
                # Backup original file
                cat feeds.conf.default
                cp feeds.conf.default feeds.conf.default.backup
                # Replace both URLs
                sed -i 's|https://git.openwrt.org/openwrt/openwrt.git|https://github.com/openwrt/openwrt.git|g' feeds.conf.default
                sed -i 's|https://git.openwrt.org/feed/packages.git|https://github.com/openwrt/packages.git|g' feeds.conf.default
                sed -i 's|https://git.openwrt.org/project/luci.git|https://github.com/openwrt/luci.git|g' feeds.conf.default
                sed -i 's|https://git.openwrt.org/feed/routing.git|https://github.com/openwrt/routing.git|g' feeds.conf.default
                sed -i 's|https://git.openwrt.org/feed/telephony.git|https://github.com/openwrt/telephony.git|g' feeds.conf.default
                echo "Updated feeds.conf.default:"
                cat feeds.conf.default
              fi
              
              if ./scripts/feeds update base packages; then
                echo "Feeds updated successfully on attempt $attempt"
                return 0
              else
                echo "Feeds update attempt $attempt failed"
                if [ $attempt -lt $max_attempts ]; then
                  local wait_time=$((attempt * 15))
                  echo "Waiting $wait_time seconds before next attempt..."
                  sleep $wait_time
                fi
                attempt=$((attempt + 1))
              fi
            done
            
            echo "All feeds update attempts failed"
            return 1
          }
          
          # Update feeds with retry and mirror fallback
          if ! update_feeds_robust; then
            echo "Failed to update feeds after all attempts"
            exit 1
          fi

          ./scripts/feeds install xtables-addons
          
          # Prepare wgobfs
          if [ -d package/xt_wgobfs/.git ]; then
            git -C package/xt_wgobfs fetch --all && git -C package/xt_wgobfs reset --hard origin/HEAD
          else
            rm -rf package/xt_wgobfs
            git clone https://github.com/infinet/xt_wgobfs.git package/xt_wgobfs
          fi
          mkdir -p ./package/feeds/packages/xtables-wgobfs
          mv ./package/xt_wgobfs/openwrt/package/Makefile ./package/feeds/packages/xtables-wgobfs
          
          make defconfig

      - name: Build xt_wgobfs packages
        run: |
          # Find SDK directory
          SDK_DIR=$(find . -maxdepth 1 -name "openwrt-sdk-*" -type d | head -n1)
          cd "$SDK_DIR"

          echo "Building xt_wgobfs packages..."
          make package/xtables-wgobfs/compile -j$(nproc) V=s  2>&1 | tail -n 30
          
          #find . -name *wg*.ipk   # find . -name "*wg*.ipk" -exec cp {} /tmp \;

          echo "Build completed. Checking for built packages..."
          find bin/ -name "*.ipk" | grep -E "(wgobfs)" | head -10

      - name: Prepare artifacts
        run: |
          # Find SDK directory
          SDK_DIR=$(find . -maxdepth 1 -name "openwrt-sdk-*" -type d | head -n1)
          
          mkdir -p wgobfsrelease
          postfix="v${{ matrix.build_env.tag }}_${{ matrix.build_env.pkgarch}}_${{ matrix.build_env.target}}_${{ matrix.build_env.subtarget}}"
          
          # Copy built packages
          find "$SDK_DIR/bin/packages" -name "iptables-mod-wgobfs_*.ipk" -exec cp {} wgobfsrelease/iptables-mod-wgobfs_${postfix}.ipk \; || echo "iptables-mod-wgobfs package not found"
          find "$SDK_DIR/bin/targets" -name "kmod-ipt-wgobfs_*.ipk" -exec cp {} wgobfsrelease/kmod-ipt-wgobfs_${postfix}.ipk \; || echo "kmod-ipt-wgobfs package not found"
          
          echo "Built packages:"
          ls -la wgobfsrelease/

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: wgobfsrelease/*.ipk
          tag_name: v${{ matrix.build_env.tag }}
